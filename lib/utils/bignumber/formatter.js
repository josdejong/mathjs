/**
 * Convert a BigNumber to a formatted string representation.
 *
 * Syntax:
 *
 *    format(value)
 *    format(value, options)
 *    format(value, precision)
 *    format(value, fn)
 *
 * Where:
 *
 *    {number} value   The value to be formatted
 *    {Object} options An object with formatting options. Available options:
 *                     {string} notation
 *                         Number notation. Choose from:
 *                         'fixed'           Always use regular number notation.
 *                                           For example '123.40' and '14000000'
 *                         'exponential'     Always use exponential notation.
 *                                           For example '1.234e+2' and '1.4e+7'
 *                         'auto' (default)  Regular number notation for numbers
 *                                           having an absolute value between
 *                                           `lower` and `upper` bounds, and uses
 *                                           exponential notation elsewhere.
 *                                           Lower bound is included, upper bound
 *                                           is excluded.
 *                                           For example '123.4' and '1.4e7'.
 *                     {number} precision    A number between 0 and 16 to round
 *                                           the digits of the number.
 *                                           In case of notations 'exponential' and
 *                                           'auto', `precision` defines the total
 *                                           number of significant digits returned
 *                                           and is undefined by default.
 *                                           In case of notation 'fixed',
 *                                           `precision` defines the number of
 *                                           significant digits after the decimal
 *                                           point, and is 0 by default.
 *                     {Object} exponential  An object containing two parameters,
 *                                           {number} lower and {number} upper,
 *                                           used by notation 'auto' to determine
 *                                           when to return exponential notation.
 *                                           Default values are `lower=1e-3` and
 *                                           `upper=1e5`.
 *                                           Only applicable for notation `auto`.
 *                     {number} roundingMode Optionally specify the rounding mode
 *                                           to customize how the formatted number
 *                                           should be formatted.
 *                                           
 *    {Function} fn    A custom formatting function. Can be used to override the
 *                     built-in notations. Function `fn` is called with `value` as
 *                     parameter and must return a string. Is useful for example to
 *                     format all values inside a matrix in a particular way.
 *
 * Examples:
 *
 *    format(6.4);                                        // '6.4'
 *    format(1240000);                                    // '1.24e6'
 *    format(1/3);                                        // '0.3333333333333333'
 *    format(1/3, 3);                                     // '0.333'
 *    format(21385, 2);                                   // '21000'
 *    format(12.071, {notation: 'fixed'});                // '12'
 *    format(2.3,    {notation: 'fixed', precision: 2});  // '2.30'
 *    format(52.8,   {notation: 'exponential'});          // '5.28e+1'
 *    format(2.34,   {notation: 'fixed', precision: 2, roundingMode: 1 });  
 *                                                        // '2.3'
 *
 * @param {BigNumber} value
 * @param {Object | Function | number} [options]
 * @return {string} str The formatted value
 */
exports.format = function (value, options) {
  if (typeof options === 'function') {
    // handle format(value, fn)
    return options(value);
  }

  // handle special cases
  if (!value.isFinite()) {
    return value.isNaN() ? 'NaN' : (value.gt(0) ? 'Infinity' : '-Infinity');
  }

  // default values for options
  var notation = 'auto';
  var precision = undefined;
  var roundingMode = undefined;

  if (options !== undefined) {
    // determine notation from options
    if (options.notation) {
      notation = options.notation;
    }
    if (options.roundingMode) {
      roundingMode = options.roundingMode;
    }

    // determine precision from options
    if (typeof options === 'number') {
      precision = options;
    }
    else if (options.precision) {
      precision = options.precision;
    }
  }

  // handle the various notations
  switch (notation) {
    case 'fixed':
      return exports.toFixed(value, precision, roundingMode);

    case 'exponential':
      return exports.toExponential(value, precision, roundingMode);

    case 'auto':
      // determine lower and upper bound for exponential notation.
      // TODO: implement support for upper and lower to be BigNumbers themselves
      var lower = 1e-3;
      var upper = 1e5;
      if (options && options.exponential) {
        if (options.exponential.lower !== undefined) {
          lower = options.exponential.lower;
        }
        if (options.exponential.upper !== undefined) {
          upper = options.exponential.upper;
        }
      }

      // adjust the configuration of the BigNumber constructor (yeah, this is quite tricky...)
      var oldConfig = {
        toExpNeg: value.constructor.toExpNeg,
        toExpPos: value.constructor.toExpPos
      };

      value.constructor.config({
        toExpNeg: Math.round(Math.log(lower) / Math.LN10),
        toExpPos: Math.round(Math.log(upper) / Math.LN10)
      });

      // handle special case zero
      if (value.isZero()) return '0';

      // determine whether or not to output exponential notation
      var str;
      var abs = value.abs();
      if (abs.gte(lower) && abs.lt(upper)) {
        // normal number notation
        str = value.toSignificantDigits(precision, roundingMode).toFixed();
      }
      else {
        // exponential notation
        str = exports.toExponential(value, precision, roundingMode);
      }

      // remove trailing zeros after the decimal point
      return str.replace(/((\.\d*?)(0+))($|e)/, function () {
        var digits = arguments[2];
        var e = arguments[4];
        return (digits !== '.') ? digits + e : e;
      });

    default:
      throw new Error('Unknown notation "' + notation + '". ' +
          'Choose "auto", "exponential", or "fixed".');
  }
};

/**
 * Format a number in exponential notation. Like '1.23e+5', '2.3e+0', '3.500e-3'
 * @param {BigNumber} value
 * @param {number} [precision]     Number of digits in formatted output.
 *                                 If not provided, the maximum available digits
 *                                 is used.
 * @param {number} [roundingMode]  Optional rounding mode to use.
 * @returns {string} str
 */
exports.toExponential = function (value, precision, roundingMode) {
  if (precision !== undefined) {
    return value.toExponential(precision - 1, roundingMode); // Note the offset of one
  }
  else {
    return value.toExponential();
  }
};

/**
 * Format a number with fixed notation.
 * @param {BigNumber} value
 * @param {number} [precision=0]        Optional number of decimals after the
 *                                      decimal point. Zero by default.
 * @param {number} [roundingMode]       Optional rounding mode to use.
 * @returns {string} str
 */
exports.toFixed = function (value, precision, roundingMode) {
  return value.toFixed(precision || 0, roundingMode);
  // Note: the (precision || 0) is needed as the toFixed of BigNumber has an
  // undefined default precision instead of 0.
};
